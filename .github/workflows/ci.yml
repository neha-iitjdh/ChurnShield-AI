# ============================================================
# GitHub Actions CI/CD Pipeline
# ============================================================
# This file tells GitHub what to do when you push code.
# Location: .github/workflows/ci.yml

# Name shown in GitHub Actions tab
name: CI/CD Pipeline

# ============================================================
# TRIGGERS: When should this pipeline run?
# ============================================================
on:
  # Run on every push to main branch
  push:
    branches: [main]

  # Run on pull requests to main branch
  pull_request:
    branches: [main]

# ============================================================
# JOBS: What tasks to run
# ============================================================
jobs:

  # ----------------------------------------------------------
  # JOB 1: Test the Backend
  # ----------------------------------------------------------
  test-backend:
    # Run on Ubuntu (Linux) virtual machine
    runs-on: ubuntu-latest

    steps:
      # Step 1: Download our code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest "httpx>=0.23.0,<0.28.0"  # Testing libraries (specific version for TestClient)

      # Step 4: Run tests
      - name: Run tests
        env:
          PYTHONPATH: src
        run: |
          pytest tests/ -v

  # ----------------------------------------------------------
  # JOB 2: Deploy Backend to Render
  # ----------------------------------------------------------
  deploy-backend:
    # Only run after tests pass
    needs: test-backend

    # Only deploy on push to main (not on pull requests)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Render
        run: |
          # Trigger Render deploy hook (webhook URL)
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}

  # ----------------------------------------------------------
  # JOB 3: Deploy Frontend to Vercel
  # ----------------------------------------------------------
  # Note: Vercel auto-deploys from GitHub by default!
  # This job is optional - just for visibility
  deploy-frontend:
    needs: test-backend
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    runs-on: ubuntu-latest

    steps:
      - name: Frontend Deploy Status
        run: |
          echo "Frontend auto-deploys via Vercel GitHub integration"
          echo "Check: https://vercel.com/dashboard"
